---
title: "GIS610: Spatial Data Visualization in R"
author: "Francesco Tonini"
date: "October 15, 2015"
output:
  html_document:
    keep_md: yes
    toc: yes
  pdf_document:
    toc: yes
---

```{r knitrOptions, include=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, fig.path='./data/figures/')
```

This lecture will walk you through some more advanced spatial data manipulation and visualization in R. __*We acknowledge that the materials provided here do not by any means intend to be comprehensive nor attempt to cover all concepts that would otherwise require a semester-long course*__. The sections and code chunks found here are derived from a variety of internet resources as well as past `R` workshops. Because this repository is open-source, please feel free to use it as you deem appropriate and I would greatly appreciate any feedback to improve and build upon it. If you are familiar with version control concepts, such as Git and Github, you are more than welcome to 'fork' this repository on your own account and send a 'pull request' to me if you wish to add/edit any of the scripts.

###Set Your Working Directory
Here, we'll use the `setwd` function to tell R where the module 1 folder is located on our machine. This will depend on the location of your downloaded course folder, Intro-Spatial-R.

```{r setwd}
# modify the filepath based on your user specific folder location
# Single or double quotes work for text strings. Must use forward slashes.

#Some common examples:
#setwd('C:/Users/username/Documents/GIS610_SpatialR/Spatial Data Visualization in R')   # for Windows users
#setwd("~/Documents/GIS610_SpatialR/Spatial Data Visualization in R")                   # ~ for Mac users
```


```{r, include=FALSE}
if (!file.exists("./data/figures")) dir.create(file.path(getwd(),"./data/figures"))
```


#Spatial Data in R: Using R as a GIS

In the previous lecture, we saw examples on how to produce basic maps within `R` as well as adding some more advanced descriptive information to them. In this section, we keep showing alternative ways in which `R` can be used as a GIS, i.e. for basic-to-intermediate mapping tasks. Let us start with some examples on how Google Maps basemaps can be pulled into `R` and basic maps be overlaid onto these "canvases". Two very useful `R` packages are `RgoogleMaps` and `plotGoogleMaps`. 

###The `RgoogleMaps` package

The three core functions within `RgoogleMap` are:  

* __GetMap()__ fetches a map tile from the Google API. Returns a list containing the image and all parameters needed to properly scale coordinates  
* __PlotOnStaticMap()__ adds point type data to an existing map  
* __PlotPolysOnStaticMap()__ adds polygon type data stored in a data structure defined by the package `PBSmapping` to an existing map in form.

```{r googlemap, fig.width=6, fig.height=6, message = FALSE, cache=TRUE}
library(RgoogleMaps)

#load dataset of interest with crime data in the SF area for 2013
load("./data/incidents2013.rda")
#list what dataset(s) has been loaded
ls()
#let's have a quick exploration of the crime dataset
dim(incidents)
head(incidents)
#let's fetch the map tile at the desired resolution and centered on a lat/lon point
SFzoom13 <- GetMap(center = c(lat = 37.77173, lon = -122.4306), 
                   destfile = "./data/figures/SanFrancisco.z13.png", 
                   GRAYSCALE = FALSE, zoom = 13, SCALE = 2, maptype = "terrain")
#let's randomly sample a number of crimes for visualization purposes
Ncrimes <- 10000
ranPts <- sample(nrow(incidents), Ncrimes)
crimes <- incidents[ranPts, ]
#We are mostly interested in looking at "violent" crimes.
#let's start by converting the variable from factor to logical
crimes$violent <- as.logical(crimes$violent)
#We want to pick two different colors for violent and non violent crimes.
#in order to overlay these colors with some transparency, we need to define the transparency "alpha" level
#inside the rgb() function. In this case we pick the colors 'red' and 'cyan' defined by
#their corresponding R-G-B values
colViolent <- rgb(1,0,0,0.3)
colNonViolent <- rgb(0,0,1,0.3)
cols <- c(colViolent, colNonViolent)
#now, we are ready to plot on our static Google Maps tile
#png("./data/figures/SanFrancisco.z13.png", width=1280, height=1280) #use if you want to save higher quality image
tmp <- PlotOnStaticMap(SFzoom13, lat = crimes$Y, lon = crimes$X, cex=0.9, 
                       pch=20, col=cols[as.numeric(crimes$violent)+1])
legend("topright", col = c(colNonViolent,colViolent), pch=20, 
       legend = c("N","Y"), title="violent", cex = 1)
#dev.off() #if you use png() remember to close the graphical device
```


####SPATIAL DATA VISUALIZATION IN R####


```{r eval=FALSE, include=FALSE}
# convert .Rmd script to .R file for instruction
# note .R file subsequently cleaned up for code margin of ~80 char

rmd2rscript <- function(infile,outfile){
  # read the file
  flIn <- readLines(infile)
  # identify the start of code blocks
  cdStrt <- which(grepl(flIn, pattern = "```{r*", perl = TRUE))
  # identify the end of code blocks
  cdEnd <- sapply(cdStrt, function(x){
    preidx <- which(grepl(flIn[-(1:x)], pattern = "```", perl = TRUE))[1]
    return(preidx + x)
  })
  # define an expansion function
  # strip code block indacators
  flIn[c(cdStrt, cdEnd)] <- ""
  expFun <- function(strt, End){
    strt <- strt+1
    End <- End-1
    return(strt:End)
  }
  idx <- unlist(mapply(FUN = expFun, strt = cdStrt, End = cdEnd, 
                SIMPLIFY = FALSE))
  # add comments to all lines except code blocks
  comIdx <- 1:length(flIn)
  comIdx <- comIdx[-idx]
  for(i in comIdx){
    flIn[i] <- paste("# ", flIn[i], sep = "")
  }
  # create an output file
  #nm <- strsplit(infile, split = "\\.")[[1]][1]
  flOut <- file(outfile, "w")
  for(i in 1:length(flIn)){
    cat(flIn[i], "\n", file = flOut, sep = "\t")
  }
  close(flOut)
}

infile <- 'SpDataVizR.Rmd'
outfile <- 'SpDataVizR.R'

rmd2rscript(infile, outfile)
```